name: Build & Publish Docker Image

on:
  push:
    branches: ["main"]
    tags: ["v*"]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/idanbot/tele-home-supervisor

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install pylint -r requirements.txt

      - name: Run Pylint
        run: |
          pylint --disable=all --enable=F,E tele_home_supervisor/ bot.py

  build-and-push:
    needs: [lint]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=sha,prefix={{branch}}-
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Compute Build Version
        id: buildver
        run: |
          TS="$(date -u +'%Y%m%d-%H%M%S')"
          echo "version=${TS}-r${GITHUB_RUN_NUMBER}" >> "$GITHUB_OUTPUT"

      # Single build step - ARM64 primary, AMD64 optional
      - name: Build and Push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # ARM64 first (your primary target), AMD64 optional
          platforms: linux/arm64,linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            BUILD_VERSION=${{ steps.buildver.outputs.version }}
          # Dual caching: GHA + Registry
          cache-from: |
            type=gha
            type=registry,ref=${{ env.IMAGE_NAME }}:buildcache
          cache-to: |
            type=gha,mode=max
            type=registry,ref=${{ env.IMAGE_NAME }}:buildcache,mode=max

      # Scan ARM64 (primary target) after push
      - name: Scan ARM64 Image
        run: |
          # Pull ARM64 variant
          docker pull --platform linux/arm64 ${{ env.IMAGE_NAME }}:latest
          
          # Scan with Trivy
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --platform linux/arm64 \
            --severity HIGH,CRITICAL \
            --exit-code 0 \
            --format table \
            ${{ env.IMAGE_NAME }}:latest

      - name: Notify Telegram
        if: always()
        env:
          STATUS: ${{ job.status }}
          REF_TYPE: ${{ github.ref_type }}
          REF_NAME: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
        run: |
          # Status Icon
          case "$STATUS" in
            success) ICON="âœ…"; TEXT="Build Success" ;;
            failure) ICON="âŒ"; TEXT="Build Failed" ;;
            *)       ICON="âš ï¸"; TEXT="Cancelled" ;;
          esac

          # Version identifier
          if [ "$REF_TYPE" == "tag" ]; then
            VERSION="$REF_NAME"
          else
            VERSION=$(echo "$SHA" | cut -c1-7)
          fi

          # Send notification
          curl -sf -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}",
            "parse_mode": "HTML",
            "disable_web_page_preview": true,
            "text": "<b>$ICON $TEXT</b>\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“¦ <b>Repo:</b> <code>${{ github.repository }}</code>\nğŸŒ¿ <b>Branch:</b> <code>$REF_NAME</code>\nğŸ”— <b>Commit:</b> <code>$VERSION</code>\nğŸ‘¤ <b>Author:</b> ${{ github.actor }}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n<a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>ğŸ” View Logs</a>"
          }
          EOF
