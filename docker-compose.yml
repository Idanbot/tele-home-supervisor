---
services:
  rpi_telebot:
    image: ghcr.io/idanbot/tele-home-supervisor:latest
    container_name: rpi-telebot
    user: "10001:10001"
    group_add:
      - "${DOCKER_GID}"

    networks:
      - bit-net

    environment:
      - BOT_TOKEN=${BOT_TOKEN}
      - BOT_AUTH_TOTP_SECRET=${BOT_AUTH_TOTP_SECRET}
      - ALLOWED_CHAT_IDS=${ALLOWED_CHAT_IDS}
      - QBT_HOST=${QBT_HOST}
      - QBT_PORT=${QBT_PORT}
      - QBT_USER=${QBT_USER}
      - QBT_PASS=${QBT_PASS}
      - WATCH_PATHS=/,/srv/media
      - SHOW_WAN=false
      - TZ=Asia/Jerusalem
      - LOG_LEVEL=DEBUG
      - RATE_LIMIT_S=${RATE_LIMIT_S:-1.0}
      - QBT_TIMEOUT_S=${QBT_TIMEOUT_S:-8}
      - DOCKER_HOST=unix:///var/run/docker.sock
      - OLLAMA_HOST=${OLLAMA_HOST:-http://localhost:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama2}
      - TPB_BASE_URL=${TPB_BASE_URL:-https://thepiratebay.org}
      - TPB_API_BASE_URL=${TPB_API_BASE_URL:-https://apibay.org}
      - TPB_API_BASE_URLS=${TPB_API_BASE_URLS:-}
      - TPB_USER_AGENT=${TPB_USER_AGENT:-}
      - TPB_COOKIE=${TPB_COOKIE:-}
      - TPB_REFERER=${TPB_REFERER:-}
      - IMDB_BASE_URL=${IMDB_BASE_URL:-https://www.imdb.com}
      - MEDIA_USER_AGENT=${MEDIA_USER_AGENT:-}
      - IMDB_COOKIE=${IMDB_COOKIE:-}
      - IMDB_REFERER=${IMDB_REFERER:-}
      - RT_BASE_URL=${RT_BASE_URL:-https://www.rottentomatoes.com}
      - RT_ALGOLIA_APP_ID=${RT_ALGOLIA_APP_ID:-}
      - RT_ALGOLIA_API_KEY=${RT_ALGOLIA_API_KEY:-}
      - RT_ALGOLIA_INDEX=${RT_ALGOLIA_INDEX:-}

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /srv/media:/srv/media:ro
      - /sys/class/thermal/thermal_zone0:/host_thermal:ro
      - ./bot_data:/app/data

    logging:
      driver: "json-file"
      options:
        max-size: "25m"
        max-file: "3"

    restart: unless-stopped

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

    logging:
      driver: "json-file"
      options:
        max-size: "25m"
        max-file: "3"

    environment:
      - TZ=Asia/Jerusalem
      # remove old images
      - WATCHTOWER_CLEANUP=true
      # check every 5 minutes
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_INCLUDE_STOPPED=true
      # also check immediately on startup
      - WATCHTOWER_UPDATE_ON_START=true
      # Docker v29 raised the minimum API version to 1.44
      - DOCKER_API_VERSION=1.44

    # Only update this specific container
    command:
      - rpi-telebot
networks:
  bit-net:
    external: true
